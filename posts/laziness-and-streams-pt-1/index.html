<!DOCTYPE html>
<html lang="en-us">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.57.2" />

    
    
    

<title>Laziness and Streams - Part 1 â€¢ </title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Laziness and Streams - Part 1"/>
<meta name="twitter:description" content="I&rsquo;m currently working my way through Functional Programming in Scala. Chapter 5 focuses on non-strictness as a property of functions. I found the chapter really fascinating because this property allows one to build a lazily evaluated list. In the next post, I&rsquo;ll try doing the same in Python. What follows here my explanation in Scala taken from the book. I try to cover the Scala specific syntax and features so hopefully this makes sense even if you&rsquo;re not familiar with Scala."/>

<meta property="og:title" content="Laziness and Streams - Part 1" />
<meta property="og:description" content="I&rsquo;m currently working my way through Functional Programming in Scala. Chapter 5 focuses on non-strictness as a property of functions. I found the chapter really fascinating because this property allows one to build a lazily evaluated list. In the next post, I&rsquo;ll try doing the same in Python. What follows here my explanation in Scala taken from the book. I try to cover the Scala specific syntax and features so hopefully this makes sense even if you&rsquo;re not familiar with Scala." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jjmalina.github.io/posts/laziness-and-streams-pt-1/" />
<meta property="article:published_time" content="2019-09-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-09-01T00:00:00+00:00" />


    






<link rel="stylesheet" href="/scss/hyde-hyde.9181f25ed2263aeb878ec6f8a84f10c4ebb16150000fca8767308880bdde5ca0.css" integrity="sha256-kYHyXtImOuuHjsb4qE8QxOuxYVAAD8qHZzCIgL3eXKA=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">


<link rel="stylesheet" href="https://jjmalina.github.io/css/override.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
</head>


    <body class="theme-base-0d ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://jjmalina.github.io"></a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://jjmalina.github.iohttps://jjmalina.github.io/jjm.png" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
        
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle"></label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/jjmalina" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/jjmalina" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2019 Jeremiah Malina
  
</div>



  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Laziness and Streams - Part 1</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Sep 01, 2019
    
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 8 min read
</div>


  </header>
  
  
  <div class="post">
    <p>I&rsquo;m currently working my way through <a href="https://www.manning.com/books/functional-programming-in-scala">Functional Programming in Scala</a>. Chapter 5 focuses on non-strictness as a property of functions. I found the chapter really fascinating because this property allows one to build a lazily evaluated list. In the next post, I&rsquo;ll try doing the same in Python. What follows here my explanation in Scala taken from the book. I try to cover the Scala specific syntax and features so hopefully this makes sense even if you&rsquo;re not familiar with Scala.</p>

<p>First the definition of <strong>non-strictness</strong>:</p>

<blockquote>
<p>Non-strictness is a property of a function. To say a function is non-strict just means
that the function may choose not to evaluate one or more of its arguments. In contrast, a strict function always evaluates its arguments.</p>
</blockquote>

<p>The problem we&rsquo;re solving:</p>

<p>Let&rsquo;s say we have an array in JavaScript and we want to transform the values and also filter them. Here we increment each number in the array and then filter to get only the even numbers.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">[<span style="color:#666">1</span>, <span style="color:#666">2</span>, <span style="color:#666">3</span>].map(num =&gt; num <span style="color:#666">+</span> <span style="color:#666">1</span>).filter(num =&gt; num <span style="color:#666">%</span> <span style="color:#666">2</span>)
</code></pre></div>
<p><code>map</code> and <code>filter</code> are great because we can decompose the operations on the elements of the array into different functions. The downside is that it&rsquo;ll take two iterations through the array; once for map and once for filter. On small arrays we won&rsquo;t mind the performance hit, but on larger arrays it could be an issue. It would be best if we could use map and filter the same way without the performance cost.</p>

<p>Below is FP In Scala&rsquo;s implementation of lazy list called <code>Stream</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">Stream._</span>  <span style="color:#080;font-style:italic">// required to override Scala&#39;s stdlib Stream
</span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">trait</span> <span style="color:#00f">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">+A</span><span style="color:#666">]</span> <span style="color:#666">{</span>
  <span style="color:#080;font-style:italic">// The arrow =&gt; in front of the argument type B means that the
</span><span style="color:#080;font-style:italic"></span>  <span style="color:#080;font-style:italic">// function f takes its second argument by name and may choose not to evaluate it.
</span><span style="color:#080;font-style:italic"></span>  <span style="color:#a2f;font-weight:bold">def</span> foldRight<span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">B</span><span style="color:#666">](</span>z<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#666">=&gt;</span> B<span style="color:#666">)(</span>f<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#666">(</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">,</span> <span style="color:#666">=&gt;</span> B<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">=&gt;</span> B<span style="color:#666">)</span><span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">B</span> <span style="color:#666">=</span>
    <span style="color:#a2f;font-weight:bold">this</span> <span style="color:#a2f;font-weight:bold">match</span> <span style="color:#666">{</span>
      <span style="color:#080;font-style:italic">// If f doesn&#39;t evaluate its second argument, the recursion never starts.
</span><span style="color:#080;font-style:italic"></span>      <span style="color:#a2f;font-weight:bold">case</span> <span style="color:#00f">Cons</span><span style="color:#666">(</span>h<span style="color:#666">,</span>t<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">=&gt;</span> f<span style="color:#666">(</span>h<span style="color:#666">(),</span> t<span style="color:#666">().</span>foldRight<span style="color:#666">(</span>z<span style="color:#666">)(</span>f<span style="color:#666">))</span>
      <span style="color:#a2f;font-weight:bold">case</span> <span style="color:#a2f;font-weight:bold">_</span> <span style="color:#a2f;font-weight:bold">=&gt;</span> z
    <span style="color:#666">}</span>

  <span style="color:#a2f;font-weight:bold">def</span> map<span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">B</span><span style="color:#666">](</span>f<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">A</span> <span style="color:#666">=&gt;</span> B<span style="color:#666">)</span><span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">B</span><span style="color:#666">]</span> <span style="color:#a2f;font-weight:bold">=</span>
    foldRight<span style="color:#666">(</span>empty<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">B</span><span style="color:#666">])((</span>a<span style="color:#666">,</span> b<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">=&gt;</span> cons<span style="color:#666">(</span>f<span style="color:#666">(</span>a<span style="color:#666">),</span> b<span style="color:#666">))</span>

  <span style="color:#a2f;font-weight:bold">def</span> filter<span style="color:#666">(</span>f<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">A</span> <span style="color:#666">=&gt;</span> <span style="color:#00f">Boolean</span><span style="color:#666">)</span><span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">]</span> <span style="color:#a2f;font-weight:bold">=</span>
    foldRight<span style="color:#666">(</span>empty<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">])((</span>a<span style="color:#666">,</span> b<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">=&gt;</span>
      <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>f<span style="color:#666">(</span>a<span style="color:#666">))</span> cons<span style="color:#666">(</span>a<span style="color:#666">,</span> b<span style="color:#666">)</span>
      <span style="color:#a2f;font-weight:bold">else</span> b<span style="color:#666">)</span>

  <span style="color:#a2f;font-weight:bold">def</span> toList<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">List</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">]</span> <span style="color:#a2f;font-weight:bold">=</span> <span style="color:#666">{</span>
    <span style="color:#a2f">@annotation</span><span style="color:#666">.</span>tailrec
    <span style="color:#a2f;font-weight:bold">def</span> go<span style="color:#666">(</span>s<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">],</span> acc<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">List</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">])</span><span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">List</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">]</span> <span style="color:#a2f;font-weight:bold">=</span> s <span style="color:#a2f;font-weight:bold">match</span> <span style="color:#666">{</span>
      <span style="color:#a2f;font-weight:bold">case</span> <span style="color:#00f">Cons</span><span style="color:#666">(</span>h<span style="color:#666">,</span>t<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">=&gt;</span> go<span style="color:#666">(</span>t<span style="color:#666">(),</span> h<span style="color:#666">()</span> <span style="color:#a2f;font-weight:bold">:</span><span style="color:#0b0;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">acc</span><span style="color:#666">)</span>
      <span style="color:#a2f;font-weight:bold">case</span> <span style="color:#a2f;font-weight:bold">_</span> <span style="color:#a2f;font-weight:bold">=&gt;</span> acc
    <span style="color:#666">}</span>
    go<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">,</span> <span style="color:#00f">List</span><span style="color:#666">()).</span>reverse
  <span style="color:#666">}</span>
<span style="color:#666">}</span>
<span style="color:#a2f;font-weight:bold">case</span> <span style="color:#a2f;font-weight:bold">object</span> <span style="color:#00f">Empty</span> <span style="color:#a2f;font-weight:bold">extends</span> <span style="color:#00f">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">Nothing</span><span style="color:#666">]</span>
<span style="color:#a2f;font-weight:bold">case</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">Cons</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">+A</span><span style="color:#666">](</span>h<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#666">()</span> <span style="color:#666">=&gt;</span> A<span style="color:#666">,</span> t<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#666">()</span> <span style="color:#666">=&gt;</span> <span style="color:#00f">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">])</span> <span style="color:#a2f;font-weight:bold">extends</span> <span style="color:#00f">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">]</span>

<span style="color:#a2f;font-weight:bold">object</span> <span style="color:#00f">Stream</span> <span style="color:#666">{</span>
  <span style="color:#a2f;font-weight:bold">def</span> cons<span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">](</span>hd<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#666">=&gt;</span> A<span style="color:#666">,</span> tl<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#666">=&gt;</span> <span style="color:#00f">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">])</span><span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">]</span> <span style="color:#a2f;font-weight:bold">=</span> <span style="color:#666">{</span>
    <span style="color:#a2f;font-weight:bold">lazy</span> <span style="color:#a2f;font-weight:bold">val</span> head <span style="color:#a2f;font-weight:bold">=</span> hd
    <span style="color:#a2f;font-weight:bold">lazy</span> <span style="color:#a2f;font-weight:bold">val</span> tail <span style="color:#a2f;font-weight:bold">=</span> tl
    <span style="color:#00f">Cons</span><span style="color:#666">(()</span> <span style="color:#a2f;font-weight:bold">=&gt;</span> head<span style="color:#666">,</span> <span style="color:#666">()</span> <span style="color:#a2f;font-weight:bold">=&gt;</span> tail<span style="color:#666">)</span>
  <span style="color:#666">}</span>

  <span style="color:#a2f;font-weight:bold">def</span> empty<span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">]</span><span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">]</span> <span style="color:#a2f;font-weight:bold">=</span> <span style="color:#00f">Empty</span>

  <span style="color:#a2f;font-weight:bold">def</span> apply<span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">](</span>as<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">A*</span><span style="color:#666">)</span><span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">]</span> <span style="color:#a2f;font-weight:bold">=</span>
    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>as<span style="color:#666">.</span>isEmpty<span style="color:#666">)</span> empty
    <span style="color:#a2f;font-weight:bold">else</span> cons<span style="color:#666">(</span>as<span style="color:#666">.</span>head<span style="color:#666">,</span> apply<span style="color:#666">(</span>as<span style="color:#666">.</span>tail<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#a2f;font-weight:bold">_</span><span style="color:#0b0;font-weight:bold">*</span><span style="color:#666">))</span>
<span style="color:#666">}</span></code></pre></div>
<p>The Scala specific part here is we have a singleton value for <code>Empty</code>, and a case class for <code>Cons</code>. The <code>Stream</code> companion implements <code>apply</code> so one can do <code>Stream(...)</code></p>

<p>Here&rsquo;s the trace of a <code>Stream</code> being constructed.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#00f">Stream</span><span style="color:#666">(</span><span style="color:#666">1</span><span style="color:#666">,</span> <span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#666">3</span><span style="color:#666">)</span>
<span style="color:#00f">Stream</span><span style="color:#666">.</span>apply<span style="color:#666">(</span><span style="color:#666">1</span><span style="color:#666">,</span> <span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#666">3</span><span style="color:#666">)</span>
<span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">1</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">.</span>apply<span style="color:#666">(</span><span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#666">3</span><span style="color:#666">))</span>
<span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">1</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">.</span>apply<span style="color:#666">(</span><span style="color:#666">3</span><span style="color:#666">)))</span>
<span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">1</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">3</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">.</span>apply<span style="color:#666">())))</span>
<span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">1</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">3</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">.</span><span style="color:#00f">Empty</span><span style="color:#666">)))</span></code></pre></div>
<p>The argument types of <code>cons</code> have the <code>=&gt;</code> operator in front of them, which means that these arguments are not <a href="https://www.scala-lang.org/files/archive/spec/2.13/04-basic-declarations-and-definitions.html#by-name-parameters">evaluated at the point of function application, but instead at each use within the function</a>, hence they&rsquo;re not strict.</p>

<p>In the third line of the trace above, the expressions <code>1</code> and <code>Stream.apply(2, 3)</code> are not evaluated when we pass them to <code>Stream.cons</code>  but instead when they are used inside <code>Stream.cons</code>. You&rsquo;ll notice that the definition of <code>cons</code> re-assigns these arguments with <code>lazy val</code>, which is like non-strictness but for variable definitions rather than arguments. <code>cons</code> passes these lazy arguments to <code>Cons</code> wrapped in a function because case classes are not allowed have lazy values. To recap, <code>hd</code> and <code>tl</code> are non-strict arguments passed to <code>Stream.cons</code>, so they are not evalued when <code>Stream.cons</code> is called. Then inside <code>Stream.cons</code> they are made lazy so using the arguments does not evaluate them when they are wrapped in a function. Now we have a single linked list that is constructed lazily. This is nice because you could in theory build a <code>Stream</code> of very expensive expressions but they would not be evaluated until the <code>Stream</code> was traversed.</p>

<p>Back to our original problem which was to not loop through an array multiple times when using <code>map</code> and <code>filter</code>.
The tool which we use for this is <code>foldRight</code></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a2f;font-weight:bold">def</span> foldRight<span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">B</span><span style="color:#666">](</span>z<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#666">=&gt;</span> B<span style="color:#666">)(</span>f<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#666">(</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">,</span> <span style="color:#666">=&gt;</span> B<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">=&gt;</span> B<span style="color:#666">)</span><span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">B</span> <span style="color:#666">=</span>
  <span style="color:#a2f;font-weight:bold">this</span> <span style="color:#a2f;font-weight:bold">match</span> <span style="color:#666">{</span>
    <span style="color:#a2f;font-weight:bold">case</span> <span style="color:#00f">Cons</span><span style="color:#666">(</span>h<span style="color:#666">,</span>t<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">=&gt;</span> f<span style="color:#666">(</span>h<span style="color:#666">(),</span> t<span style="color:#666">().</span>foldRight<span style="color:#666">(</span>z<span style="color:#666">)(</span>f<span style="color:#666">))</span>
    <span style="color:#a2f;font-weight:bold">case</span> <span style="color:#a2f;font-weight:bold">_</span> <span style="color:#a2f;font-weight:bold">=&gt;</span> z
  <span style="color:#666">}</span></code></pre></div>
<p><code>foldRight</code> travels recursively to the right along the singly linked list and calls a function <code>f</code>. If it gets to the end, it returns <code>z</code> which is a non-strict expression. In the previous iteration, the right side of <code>f(h(), t().foldRight(z)(f))</code> returns <code>z</code> so we get <code>f(h(), z)</code>, the head is evaluated and we pop back up. If we wanted to sum the elements of a Stream we could do:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#00f">Stream</span><span style="color:#666">(</span><span style="color:#666">1</span><span style="color:#666">,</span> <span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#666">3</span><span style="color:#666">).</span>foldRight<span style="color:#666">(</span><span style="color:#666">0</span><span style="color:#666">)((</span>a<span style="color:#666">,</span> b<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">=&gt;</span> a <span style="color:#666">+</span> b<span style="color:#666">)</span></code></pre></div>
<p>This will immediately evalute to <code>6</code>, but we can use <code>foldRight</code> to implement <code>map</code> and <code>filter</code>. (In the code above, map takes <code>f</code> but I renamed it to be easier to read below.)</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a2f;font-weight:bold">def</span> map<span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">B</span><span style="color:#666">](</span>mapper<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">A</span> <span style="color:#666">=&gt;</span> B<span style="color:#666">)</span><span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">B</span><span style="color:#666">]</span> <span style="color:#a2f;font-weight:bold">=</span>
  foldRight<span style="color:#666">(</span>empty<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">B</span><span style="color:#666">])((</span>a<span style="color:#666">,</span> b<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">=&gt;</span> cons<span style="color:#666">(</span>mapper<span style="color:#666">(</span>a<span style="color:#666">),</span> b<span style="color:#666">))</span></code></pre></div>
<p><code>map</code> creates a new Stream but lazily because it&rsquo;s built on <code>cons</code>. The expression <code>mapper(a)</code> would reference <code>a</code> which is really the head of the <code>Stream</code> that foldRight is called on but since <code>cons</code> takes its parameters by-name, it&rsquo;s not actually evaluated. The same happens with <code>b</code> which is the expression <code>t().foldRight(z)(mapper)</code></p>

<p>In other words <code>f(h(), t().foldRight(z)(f))</code> =&gt; <code>cons(mapper(h()), t().foldRight(Empty)(mapper))</code></p>

<p>Now let&rsquo;s look at filter:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a2f;font-weight:bold">def</span> filter<span style="color:#666">(</span>f<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">A</span> <span style="color:#666">=&gt;</span> <span style="color:#00f">Boolean</span><span style="color:#666">)</span><span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">]</span> <span style="color:#a2f;font-weight:bold">=</span>
  foldRight<span style="color:#666">(</span>empty<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">])((</span>a<span style="color:#666">,</span> b<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">=&gt;</span>
    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>f<span style="color:#666">(</span>a<span style="color:#666">))</span> cons<span style="color:#666">(</span>a<span style="color:#666">,</span> b<span style="color:#666">)</span>
    <span style="color:#a2f;font-weight:bold">else</span> b<span style="color:#666">)</span></code></pre></div>
<p>The idea with <code>filter</code> is similar to <code>map</code> but we only call <code>cons</code> if <code>f(a)</code> is true.</p>

<p>Again because <code>cons</code> is call by name, re-assigns the parameters with <code>lazy val</code> and wraps them in a function, it doesn&rsquo;t evalute its arguments when they&rsquo;re applied to it. The other key detail is that the function <code>f</code> passed to <code>foldRight</code> has the signature <code>f: (A, =&gt; B) =&gt; B</code> so its second argument is call by name and is not evaluated when applied.</p>

<p>Now let&rsquo;s write a trace for our original add one and take even numbers program.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#00f">Stream</span><span style="color:#666">(</span><span style="color:#666">1</span><span style="color:#666">,</span> <span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#666">3</span><span style="color:#666">).</span>map<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">_</span> <span style="color:#666">+</span> <span style="color:#666">1</span><span style="color:#666">).</span>filter<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">_</span> <span style="color:#666">%</span> <span style="color:#666">2</span> <span style="color:#666">==</span> <span style="color:#666">0</span><span style="color:#666">)</span> <span style="color:#080;font-style:italic">// _ is shorthand for an anonymous function with one arg
</span><span style="color:#080;font-style:italic">// _ + 1 is applied to the first element and we get 2
</span><span style="color:#080;font-style:italic"></span><span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">(</span><span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#666">3</span><span style="color:#666">).</span>map<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">_</span> <span style="color:#666">+</span> <span style="color:#666">1</span><span style="color:#666">)).</span>filter<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">_</span> <span style="color:#666">%</span> <span style="color:#666">2</span> <span style="color:#666">==</span> <span style="color:#666">0</span><span style="color:#666">)</span>
<span style="color:#080;font-style:italic">// _ % 2 == 0 is applied to the first element 2, it passes so the item stays
</span><span style="color:#080;font-style:italic">// so now map and filter are called on the tail
</span><span style="color:#080;font-style:italic"></span><span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">(</span><span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#666">3</span><span style="color:#666">).</span>map<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">_</span> <span style="color:#666">+</span> <span style="color:#666">1</span><span style="color:#666">).</span>filter<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">_</span> <span style="color:#666">%</span> <span style="color:#666">2</span> <span style="color:#666">==</span> <span style="color:#666">0</span><span style="color:#666">))</span>
<span style="color:#080;font-style:italic">// _ + 1 is applied to the second element and we get 3
</span><span style="color:#080;font-style:italic"></span><span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">3</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">(</span><span style="color:#666">3</span><span style="color:#666">).</span>map<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">_</span> <span style="color:#666">+</span> <span style="color:#666">1</span><span style="color:#666">)).</span>filter<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">_</span> <span style="color:#666">%</span> <span style="color:#666">2</span> <span style="color:#666">==</span> <span style="color:#666">0</span><span style="color:#666">))</span>
<span style="color:#080;font-style:italic">// _ % 2 == 0 is applied to the second element 3 and it&#39;s odd so  it&#39;s gone
</span><span style="color:#080;font-style:italic"></span><span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">(</span><span style="color:#666">3</span><span style="color:#666">).</span>map<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">_</span> <span style="color:#666">+</span> <span style="color:#666">1</span><span style="color:#666">).</span>filter<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">_</span> <span style="color:#666">%</span> <span style="color:#666">2</span> <span style="color:#666">==</span> <span style="color:#666">0</span><span style="color:#666">))</span>
<span style="color:#080;font-style:italic">// _ + 1 is applied to the second element 3 so it&#39;s 4
</span><span style="color:#080;font-style:italic"></span><span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">4</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">.</span>empty<span style="color:#666">).</span>filter<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">_</span> <span style="color:#666">%</span> <span style="color:#666">2</span> <span style="color:#666">==</span> <span style="color:#666">0</span><span style="color:#666">))</span>
<span style="color:#080;font-style:italic">// _ % 2 is applied to the second element and it&#39;s even so it stays
</span><span style="color:#080;font-style:italic"></span><span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">.</span>cons<span style="color:#666">(</span><span style="color:#666">4</span><span style="color:#666">,</span> <span style="color:#00f">Stream</span><span style="color:#666">.</span>empty<span style="color:#666">))</span>
<span style="color:#080;font-style:italic">// the final result is equivalent to
</span><span style="color:#080;font-style:italic"></span><span style="color:#00f">Stream</span><span style="color:#666">(</span><span style="color:#666">2</span><span style="color:#666">,</span> <span style="color:#666">4</span><span style="color:#666">)</span></code></pre></div>
<p>Calling <code>map</code> and <code>filter</code> won&rsquo;t actually evaluate the stream because they lazily construct new streams. What you can see here is that <code>map</code> and <code>filter</code>&rsquo;s functions are being applied one after another to the first element, then the second and so on. This was the aha moment for me because we no longer have to repeatedly loop through a single linked list for <code>map</code> and <code>filter</code>!
If we wanted to convert the stream to a list and evaluate everything to have the values in memory we could add a <code>toList</code> method</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#080;font-style:italic">// this goes into the body of &#39;trait Stream&#39;
</span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">def</span> toList<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">List</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">]</span> <span style="color:#a2f;font-weight:bold">=</span> <span style="color:#666">{</span>
  <span style="color:#a2f">@annotation</span><span style="color:#666">.</span>tailrec
  <span style="color:#a2f;font-weight:bold">def</span> go<span style="color:#666">(</span>s<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">Stream</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">],</span> acc<span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">List</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">])</span><span style="color:#a2f;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">List</span><span style="color:#666">[</span><span style="color:#0b0;font-weight:bold">A</span><span style="color:#666">]</span> <span style="color:#a2f;font-weight:bold">=</span> s <span style="color:#a2f;font-weight:bold">match</span> <span style="color:#666">{</span>
    <span style="color:#a2f;font-weight:bold">case</span> <span style="color:#00f">Cons</span><span style="color:#666">(</span>h<span style="color:#666">,</span>t<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">=&gt;</span> go<span style="color:#666">(</span>t<span style="color:#666">(),</span> h<span style="color:#666">()</span> <span style="color:#a2f;font-weight:bold">:</span><span style="color:#0b0;font-weight:bold">:</span> <span style="color:#0b0;font-weight:bold">acc</span><span style="color:#666">)</span>
    <span style="color:#a2f;font-weight:bold">case</span> <span style="color:#a2f;font-weight:bold">_</span> <span style="color:#a2f;font-weight:bold">=&gt;</span> acc
  <span style="color:#666">}</span>
  go<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">,</span> <span style="color:#00f">List</span><span style="color:#666">()).</span>reverse
<span style="color:#666">}</span></code></pre></div>
<p>Since <code>go</code> starts from the right, we end up with the stream values in reverse order, hence the <code>.reverse</code> at the end. If we wanted to evaluate <code>Stream(1, 2, 3).map(_ + 1).filter(_ % 2 == 0)</code> we just put a <code>.toList</code> at the end. The caveat with the whole solution is that <code>foldRight</code> as it&rsquo;s written is not tail recursive, so it could stack overflow.</p>

<p>Pretty cool huh? At this point I was curious about being able to do this in Python and JavaScript which I&rsquo;m more familiar with. I found this <a href="https://blog.jeremyfairbank.com/javascript/functional-javascript-streams-2/">great article by Jeremy Fairbank on creating functional streams in JavaScript</a></p>

<p>Python is my go-to language, so in the next post I&rsquo;ll implement <code>Stream</code> in Python. The challenge is that Python doesn&rsquo;t non-strictness or laziness the same way that Scala does.</p>

  </div>
  

<div class="navigation navigation-single">
    
    
</div>


  

  
    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.5.0/js/all.js" integrity="sha384-GqVMZRt5Gn7tB9D9q7ONtcp4gtHIUEW/yG7h98J7IpE3kpi+srfFyyB/04OV6pG0" crossorigin="anonymous"></script>


    
    
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    




    



    </body>
</html>
